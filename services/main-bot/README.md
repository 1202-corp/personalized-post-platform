# Main Bot

Telegram –±–æ—Ç –Ω–∞ Aiogram 3.x —Å AARRR –≤–æ—Ä–æ–Ω–∫–æ–π.

## –°—Ç–µ–∫

- **Aiogram 3.x** ‚Äî Telegram Bot API
- **FSM (MemoryStorage)** ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **httpx** ‚Äî HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è API

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
bot/
‚îú‚îÄ‚îÄ main.py              # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞, polling/webhook
‚îú‚îÄ‚îÄ config.py            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ env
‚îú‚îÄ‚îÄ api_client.py        # HTTP –∫–ª–∏–µ–Ω—Ç—ã –¥–ª—è core-api –∏ user-bot
‚îú‚îÄ‚îÄ message_manager.py   # Registry Pattern –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ keyboards.py         # Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚îú‚îÄ‚îÄ texts.py             # –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (en/ru)
‚îú‚îÄ‚îÄ retention.py         # Retention —Å–µ—Ä–≤–∏—Å (nudges)
‚îî‚îÄ‚îÄ handlers/
    ‚îú‚îÄ‚îÄ commands.py      # /start, /help, /status, /reset
    ‚îú‚îÄ‚îÄ training.py      # –§–ª–æ—É –æ–±—É—á–µ–Ω–∏—è
    ‚îî‚îÄ‚îÄ feed.py          # –§–ª–æ—É –ª–µ–Ω—Ç—ã + –±–æ–Ω—É—Å –∫–∞–Ω–∞–ª
```

## MessageManager (Registry Pattern)

–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏:

| –¢–∏–ø | –ü–æ–≤–µ–¥–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-----|-----------|--------|
| `SYSTEM` | Persistent, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è in-place | –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é |
| `EPHEMERAL` | –£–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è | –î–∏–∞–ª–æ–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è |
| `ONETIME` | –û—Å—Ç–∞—ë—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ | –ü–æ—Å—Ç—ã –ª–µ–Ω—Ç—ã |

```python
# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ)
await message_manager.send_system(chat_id, "Menu", reply_markup=kb)

# –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–≥–æ–º –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
await message_manager.send_ephemeral(chat_id, "Loading...", tag="loading")
await message_manager.delete_ephemeral(chat_id, tag="loading")

# –ü–æ—Å—Ç –≤ –ª–µ–Ω—Ç—É (–Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è)
await message_manager.send_onetime(chat_id, text, reply_markup=kb)
```

## Handlers

### commands.py
- `/start` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
- `/help` ‚Äî —Å–ø—Ä–∞–≤–∫–∞
- `/status` ‚Äî —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `/reset` ‚Äî –æ—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

### training.py
- –§–ª–æ—É –æ–±—É—á–µ–Ω–∏—è (FSM: `TrainingStates`)
- –û—Ü–µ–Ω–∫–∞ –ø–æ—Å—Ç–æ–≤ (üëç/üëé/‚è≠Ô∏è)
- MiniApp –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- Prefetch –º–µ–¥–∏–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
- Nudges –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### feed.py
- –ü–æ–∫–∞–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ª–µ–Ω—Ç—ã
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —è–∑—ã–∫–∞
- –ü–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏

## Retention Service

–§–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —é–∑–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç nudge —Å –ª—É—á—à–∏–º –ø–æ—Å—Ç–æ–º
3. –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —é–∑–µ—Ä–æ–≤ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—É—á–µ–Ω–∏—è

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **Prefetch –º–µ–¥–∏–∞** ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–∏—Ö –ø–æ—Å—Ç–æ–≤ –≤ —Ñ–æ–Ω–µ
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** ‚Äî –∞–ª—å–±–æ–º—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
- **–ö—ç—à –º–µ–¥–∏–∞** ‚Äî –¥–æ 30 –ø–æ—Å—Ç–æ–≤ –≤ –ø–∞–º—è—Ç–∏
- **Double-click protection** ‚Äî –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–µ–π

## –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

```bash
cd services/main-bot
pip install -r requirements.txt
python -m bot.main
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|----------|
| `TELEGRAM_BOT_TOKEN` | –¢–æ–∫–µ–Ω –±–æ—Ç–∞ |
| `CORE_API_URL` | URL mock-core-api |
| `USER_BOT_URL` | URL user-bot |
| `MINIAPP_URL` | URL MiniApp (—Å —Ç—É–Ω–Ω–µ–ª–µ–º) |
| `RETENTION_CHECK_INTERVAL` | –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ retention |
